// Prisma Schema for Nobre CRM
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum UserRole {
  admin
  sdr
  closer_ht
  closer_lt
  production
  post_sales
  manager_sales
  manager_production
  strategic
}

enum PipelineType {
  high_ticket
  low_ticket
  sales
  production
  post_sales
}

enum LeadSource {
  website
  instagram
  whatsapp
  facebook
  google_ads
  indicacao
  outro
}

// High Ticket statuses
enum HighTicketStatus {
  novo
  qualificado
  call_agendada
  proposta
  negociacao
  fechado
  perdido
}

// Low Ticket statuses
enum LowTicketStatus {
  novo
  atribuido
  em_negociacao
  fechado
  perdido
}

// Production statuses
enum ProductionStatus {
  backlog
  fazendo
  revisao
  concluido
}

// Post-Sales statuses
enum PostSalesStatus {
  novo
  onboarding
  acompanhamento
  renovacao
  encerrado
}

enum InteractionType {
  note
  call
  whatsapp
  email
  status_change
  assignment
}

// ============ MODELS ============

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String       @map("password_hash")
  name         String
  role         UserRole
  pipelineType PipelineType? @map("pipeline_type")
  isActive     Boolean      @default(true) @map("is_active")
  
  // Chat/Atendimento fields
  maxConcurrentChats Int     @default(5) @map("max_concurrent_chats")
  currentChatCount   Int     @default(0) @map("current_chat_count")
  isOnline           Boolean @default(false) @map("is_online")
  
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  // Relations
  assignedLeads   Lead[]         @relation("AssignedLeads")
  interactions    Interaction[]
  sentMessages    Message[]      @relation("SentMessages")
  conversations   Conversation[] @relation("AgentConversations")
  
  @@map("users")
}

model Lead {
  id           String       @id @default(uuid())
  name         String
  email        String?
  phone        String
  company      String?
  source       LeadSource   @default(website)
  
  // Pipeline
  pipeline     PipelineType @default(high_ticket)
  statusHT     HighTicketStatus? @map("status_ht")
  statusLT     LowTicketStatus?  @map("status_lt")
  statusProduction ProductionStatus? @map("status_production")
  statusPostSales PostSalesStatus? @map("status_post_sales")
  
  // Assignment
  assignedTo   String?      @map("assigned_to")
  assignedUser User?        @relation("AssignedLeads", fields: [assignedTo], references: [id])
  assignedAt   DateTime?    @map("assigned_at")
  
  // Value
  estimatedValue Decimal    @default(0) @map("estimated_value") @db.Decimal(10,2)
  
  // Metadata
  tags         String[]     @default([])
  notes        String?      @db.Text
  contactReason String?     @map("contact_reason")  // Reason for contact / "Qual seu maior desafio hoje"
  
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  // Relations
  interactions  Interaction[]
  messages      Message[]
  conversations Conversation[]
  queueEntries  Queue[]
  
  @@map("leads")
}

model Interaction {
  id        String          @id @default(uuid())
  leadId    String          @map("lead_id")
  lead      Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String?         @map("user_id")
  user      User?           @relation(fields: [userId], references: [id])
  
  type      InteractionType
  content   String?         @db.Text
  metadata  Json?
  
  createdAt DateTime        @default(now()) @map("created_at")
  
  @@map("interactions")
}

// ============ WHATSAPP MESSAGES ============

enum MessageDirection {
  in
  out
}

enum MessageType {
  text
  image
  audio
  video
  document
  template
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

model Message {
  id            String           @id @default(uuid())
  waMessageId   String?          @unique @map("wa_message_id") // WhatsApp message ID from 360Dialog
  
  // Related lead (optional - we match by phone)
  leadId        String?          @map("lead_id")
  lead          Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Related conversation
  conversationId String?         @map("conversation_id")
  conversation   Conversation?   @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  
  // Phone number (normalized, no +)
  phone         String
  
  // Message content
  direction     MessageDirection
  type          MessageType      @default(text)
  text          String?          @db.Text
  mediaUrl      String?          @map("media_url")
  templateName  String?          @map("template_name")
  
  // Status tracking
  status        MessageStatus    @default(pending)
  
  // Agent who sent (for outgoing messages)
  sentByUserId  String?          @map("sent_by_user_id")
  sentByUser    User?            @relation("SentMessages", fields: [sentByUserId], references: [id])
  
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  
  @@index([phone])
  @@index([leadId])
  @@index([conversationId])
  @@map("messages")
}

// ============ OMNICHANNEL CHAT ============

enum ConversationStatus {
  queued
  active
  closed
}

enum ConversationChannel {
  whatsapp
  instagram
  email
  manual
}

enum ClosedReason {
  payment
  no_interest
  transferred
  resolved
  timeout
}

model Conversation {
  id              String              @id @default(uuid())
  
  // Related lead
  leadId          String              @map("lead_id")
  lead            Lead                @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Assigned agent
  assignedAgentId String?             @map("assigned_agent_id")
  assignedAgent   User?               @relation("AgentConversations", fields: [assignedAgentId], references: [id])
  
  // Channel and status
  channel         ConversationChannel @default(whatsapp)
  status          ConversationStatus  @default(queued)
  closedReason    ClosedReason?       @map("closed_reason")
  
  // Pipeline for routing
  pipeline        PipelineType        @default(high_ticket)
  
  // Timestamps
  lastMessageAt   DateTime?           @map("last_message_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  closedAt        DateTime?           @map("closed_at")
  
  // Relations
  messages        Message[]
  
  @@index([leadId])
  @@index([assignedAgentId])
  @@index([status])
  @@index([pipeline])
  @@map("conversations")
}

enum QueueStatus {
  waiting
  assigned
  expired
}

model Queue {
  id         String      @id @default(uuid())
  
  // Related lead
  leadId     String      @map("lead_id")
  lead       Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Pipeline for routing
  pipeline   PipelineType
  
  // Status
  status     QueueStatus @default(waiting)
  priority   Int         @default(0)
  
  // Timestamps
  createdAt  DateTime    @default(now()) @map("created_at")
  assignedAt DateTime?   @map("assigned_at")
  
  @@index([pipeline])
  @@index([status])
  @@map("queue")
}

