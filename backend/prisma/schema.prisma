// Prisma Schema for Nobre CRM
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum UserRole {
  admin
  sdr
  closer_ht
  closer_lt
  production
  post_sales
  manager_sales
  manager_production
  strategic
}

enum PipelineType {
  high_ticket
  low_ticket
  sales
  production
  post_sales
}

enum LeadSource {
  website
  instagram
  whatsapp
  facebook
  google_ads
  indicacao
  outro
}

// High Ticket statuses
enum HighTicketStatus {
  novo
  qualificado
  call_agendada
  proposta
  negociacao
  fechado
  perdido
}

// Low Ticket statuses
enum LowTicketStatus {
  novo
  atribuido
  em_negociacao
  fechado
  perdido
}

// Production statuses
enum ProductionStatus {
  backlog
  fazendo
  revisao
  concluido
}

// Post-Sales statuses
enum PostSalesStatus {
  novo
  onboarding
  acompanhamento
  renovacao
  encerrado
}

enum InteractionType {
  note
  call
  whatsapp
  email
  status_change
  assignment
}

// Deal status for tracking business opportunities
enum DealStatus {
  open
  won
  lost
}

// Scheduled message status
enum ScheduleStatus {
  pending
  sent
  cancelled
  failed
}

// Lead history action types
enum LeadHistoryAction {
  stage_changed
  assigned
  deal_created
  deal_closed
  tag_added
  tag_removed
  note_added
  contact_updated
  marked_lost
  tags_updated
}

// ============ MODELS ============

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String       @map("password_hash")
  name         String
  role         UserRole
  pipelineType PipelineType? @map("pipeline_type")
  isActive     Boolean      @default(true) @map("is_active")
  
  // Chat/Atendimento fields
  maxConcurrentChats Int     @default(5) @map("max_concurrent_chats")
  currentChatCount   Int     @default(0) @map("current_chat_count")
  isOnline           Boolean @default(false) @map("is_online")
  
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  // Relations
  assignedLeads      Lead[]             @relation("AssignedLeads")
  interactions       Interaction[]
  sentMessages       Message[]          @relation("SentMessages")
  conversations      Conversation[]     @relation("AgentConversations")
  ownedDeals         Deal[]             @relation("OwnedDeals")
  scheduledMessages  ScheduledMessage[] @relation("ScheduledMessages")
  historyActions     LeadHistory[]      @relation("UserHistoryActions")
  
  @@map("users")
}

model Lead {
  id           String       @id @default(uuid())
  name         String
  email        String?
  phone        String
  company      String?
  source       LeadSource   @default(website)
  
  // Pipeline
  pipeline     PipelineType @default(high_ticket)
  statusHT     HighTicketStatus? @map("status_ht")
  statusLT     LowTicketStatus?  @map("status_lt")
  statusProduction ProductionStatus? @map("status_production")
  statusPostSales PostSalesStatus? @map("status_post_sales")
  
  // Assignment
  assignedTo   String?      @map("assigned_to")
  assignedUser User?        @relation("AssignedLeads", fields: [assignedTo], references: [id])
  assignedAt   DateTime?    @map("assigned_at")
  
  // Value
  estimatedValue Decimal    @default(0) @map("estimated_value") @db.Decimal(10,2)
  
  // Metadata
  tags         String[]     @default([])
  notes        String?      @db.Text
  contactReason String?     @map("contact_reason")  // Reason for contact / "Qual seu maior desafio hoje"
  
  // Loss tracking
  lostAt       DateTime?    @map("lost_at")
  lossReasonId String?      @map("loss_reason_id")
  
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  // Relations
  interactions  Interaction[]
  messages      Message[]
  conversations Conversation[]
  queueEntries  Queue[]
  deals         Deal[]
  history       LeadHistory[]
  
  @@map("leads")
}

model Interaction {
  id        String          @id @default(uuid())
  leadId    String          @map("lead_id")
  lead      Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    String?         @map("user_id")
  user      User?           @relation(fields: [userId], references: [id])
  
  type      InteractionType
  content   String?         @db.Text
  metadata  Json?
  
  createdAt DateTime        @default(now()) @map("created_at")
  
  @@map("interactions")
}

// ============ WHATSAPP MESSAGES ============

enum MessageDirection {
  in
  out
}

enum MessageType {
  text
  image
  audio
  video
  document
  template
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

model Message {
  id            String           @id @default(uuid())
  waMessageId   String?          @unique @map("wa_message_id") // WhatsApp message ID from 360Dialog
  
  // Related lead (optional - we match by phone)
  leadId        String?          @map("lead_id")
  lead          Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Related conversation
  conversationId String?         @map("conversation_id")
  conversation   Conversation?   @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  
  // Phone number (normalized, no +)
  phone         String
  
  // Message content
  direction     MessageDirection
  type          MessageType      @default(text)
  text          String?          @db.Text
  mediaUrl      String?          @map("media_url")
  templateName  String?          @map("template_name")
  
  // Status tracking
  status        MessageStatus    @default(pending)
  
  // Agent who sent (for outgoing messages)
  sentByUserId  String?          @map("sent_by_user_id")
  sentByUser    User?            @relation("SentMessages", fields: [sentByUserId], references: [id])
  
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  
  @@index([phone])
  @@index([leadId])
  @@index([conversationId])
  @@map("messages")
}

// ============ OMNICHANNEL CHAT ============

enum ConversationStatus {
  queued
  active
  on_hold
  closed
}

enum ConversationChannel {
  whatsapp
  instagram
  email
  manual
}

enum ClosedReason {
  payment
  no_interest
  transferred
  resolved
  timeout
}

model Conversation {
  id              String              @id @default(uuid())
  
  // Related lead
  leadId          String              @map("lead_id")
  lead            Lead                @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Assigned agent
  assignedAgentId String?             @map("assigned_agent_id")
  assignedAgent   User?               @relation("AgentConversations", fields: [assignedAgentId], references: [id])
  
  // Channel and status
  channel         ConversationChannel @default(whatsapp)
  status          ConversationStatus  @default(queued)
  closedReason    ClosedReason?       @map("closed_reason")
  
  // Pipeline for routing
  pipeline        PipelineType        @default(high_ticket)
  
  // Timestamps
  lastMessageAt   DateTime?           @map("last_message_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  closedAt        DateTime?           @map("closed_at")
  
  // Relations
  messages           Message[]
  scheduledMessages  ScheduledMessage[]
  
  @@index([leadId])
  @@index([assignedAgentId])
  @@index([status])
  @@index([pipeline])
  @@map("conversations")
}

enum QueueStatus {
  waiting
  assigned
  expired
}

model Queue {
  id         String      @id @default(uuid())
  
  // Related lead
  leadId     String      @map("lead_id")
  lead       Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Pipeline for routing
  pipeline   PipelineType
  
  // Status
  status     QueueStatus @default(waiting)
  priority   Int         @default(0)
  
  // Timestamps
  createdAt  DateTime    @default(now()) @map("created_at")
  assignedAt DateTime?   @map("assigned_at")
  
  @@index([pipeline])
  @@index([status])
  @@map("queue")
}

// ============ DEALS (Multiple businesses per lead) ============

model Deal {
  id            String      @id @default(uuid())
  
  // Related lead
  leadId        String      @map("lead_id")
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Business info
  value         Decimal     @default(0) @db.Decimal(10,2)
  product       String?
  origin        String?     // Levantada de mão, Inbound, etc.
  
  // Status and stage
  status        DealStatus  @default(open)
  stage         String?     // Current stage in funnel
  pipeline      PipelineType @default(high_ticket)
  
  // Owner
  ownerId       String?     @map("owner_id")
  owner         User?       @relation("OwnedDeals", fields: [ownerId], references: [id])
  
  // Notes
  notes         String?     @db.Text
  temperature   String?     // hot, warm, cold
  recordingUrl  String?     @map("recording_url")
  
  // Timestamps
  closedAt      DateTime?   @map("closed_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  @@index([leadId])
  @@index([ownerId])
  @@index([status])
  @@map("deals")
}

// ============ SCHEDULED MESSAGES ============

model ScheduledMessage {
  id              String         @id @default(uuid())
  
  // Related conversation
  conversationId  String         @map("conversation_id")
  conversation    Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Message content
  content         String         @db.Text
  
  // Schedule
  scheduledFor    DateTime       @map("scheduled_for")
  status          ScheduleStatus @default(pending)
  
  // Created by
  createdById     String         @map("created_by_id")
  createdBy       User           @relation("ScheduledMessages", fields: [createdById], references: [id])
  
  // Result
  sentAt          DateTime?      @map("sent_at")
  errorMessage    String?        @map("error_message")
  
  createdAt       DateTime       @default(now()) @map("created_at")
  
  @@index([conversationId])
  @@index([scheduledFor])
  @@index([status])
  @@map("scheduled_messages")
}

// ============ LEAD HISTORY (Activity log) ============

model LeadHistory {
  id        String            @id @default(uuid())
  
  // Related lead
  leadId    String            @map("lead_id")
  lead      Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Action details
  action    LeadHistoryAction
  details   Json?             // { from: "Base", to: "Prospecção", dealId: "..." }
  
  // Who performed
  userId    String?           @map("user_id")
  user      User?             @relation("UserHistoryActions", fields: [userId], references: [id])
  
  createdAt DateTime          @default(now()) @map("created_at")
  
  @@index([leadId])
  @@index([createdAt])
  @@map("lead_history")
}

// ============ CUSTOM FIELDS (Dynamic fields for Contact/Company/Deal) ============

enum CustomFieldType {
  text
  number
  date
  select
  multiselect
  url
  email
  phone
}

enum CustomFieldEntity {
  contact
  company
  deal
}

model CustomField {
  id          String            @id @default(uuid())
  
  name        String            // Display name: "Instagram", "CNPJ", etc.
  key         String            // Internal key: "instagram", "cnpj"
  type        CustomFieldType   @default(text)
  entity      CustomFieldEntity // Which entity this field belongs to
  
  // For select/multiselect types
  options     Json?             // ["Option 1", "Option 2"]
  
  // Display settings
  order       Int               @default(0)
  isVisible   Boolean           @default(true) @map("is_visible")
  isRequired  Boolean           @default(false) @map("is_required")
  placeholder String?
  
  // Tenant isolation (for multi-tenant)
  tenantId    String?           @map("tenant_id")
  
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  
  // Values stored per lead
  values      CustomFieldValue[]
  
  @@unique([key, entity, tenantId])
  @@index([entity])
  @@map("custom_fields")
}

model CustomFieldValue {
  id            String       @id @default(uuid())
  
  // Related custom field
  customFieldId String       @map("custom_field_id")
  customField   CustomField  @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  
  // Related lead
  leadId        String       @map("lead_id")
  
  // The value (stored as string, parsed based on field type)
  value         String?      @db.Text
  
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  
  @@unique([customFieldId, leadId])
  @@index([leadId])
  @@map("custom_field_values")
}

// ============ PLAYBOOKS & ACTIVITIES ============

enum ActivityType {
  call
  whatsapp
  email
  meeting
  task
  follow_up
}

enum ActivityStatus {
  pending
  completed
  skipped
  overdue
}

model Playbook {
  id          String     @id @default(uuid())
  
  name        String     // "Playbook Prospecção SDR"
  description String?
  
  // Optional: Link to specific stage
  stageKey    String?    @map("stage_key")
  pipeline    PipelineType?
  
  isActive    Boolean    @default(true) @map("is_active")
  tenantId    String?    @map("tenant_id")
  
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  
  // Template activities for this playbook
  templates   ActivityTemplate[]
  
  @@map("playbooks")
}

model ActivityTemplate {
  id          String       @id @default(uuid())
  
  // Parent playbook
  playbookId  String       @map("playbook_id")
  playbook    Playbook     @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  
  // Activity details
  type        ActivityType
  title       String       // "Tentativa de contato 1"
  description String?
  
  // Scheduling
  daysFromStart Int        @default(1) @map("days_from_start") // Days after lead enters stage
  order         Int        @default(0)
  
  // Optional message template
  messageTemplate String?  @map("message_template") @db.Text
  
  createdAt   DateTime     @default(now()) @map("created_at")
  
  @@index([playbookId])
  @@map("activity_templates")
}

model Activity {
  id          String         @id @default(uuid())
  
  // Related lead
  leadId      String         @map("lead_id")
  
  // Activity details
  type        ActivityType
  title       String
  description String?
  
  // Schedule and status
  dueDate     DateTime       @map("due_date")
  status      ActivityStatus @default(pending)
  completedAt DateTime?      @map("completed_at")
  
  // Assigned user
  assignedTo  String?        @map("assigned_to")
  
  // Source template (if from playbook)
  templateId  String?        @map("template_id")
  
  // Notes when completed
  notes       String?        @db.Text
  
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  
  @@index([leadId])
  @@index([dueDate])
  @@index([status])
  @@index([assignedTo])
  @@map("activities")
}

// ============ LOSS REASONS ============

model LossReason {
  id        String   @id @default(uuid())
  
  name      String   // "Sem dinheiro", "Comprou concorrente", etc.
  order     Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  tenantId  String?  @map("tenant_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("loss_reasons")
}

