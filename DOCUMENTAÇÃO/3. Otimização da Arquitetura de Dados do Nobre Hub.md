# Otimização da Arquitetura de Dados do Nobre Hub: Suporte a Funcionalidades Complexas

**Autor:** Manus AI
**Data:** 16 de Janeiro de 2026
**Versão:** 1.0

## 1. Introdução e Análise de Limitações

A arquitetura de dados original do Nobre Hub (v2.0) é funcional para um MVP (Produto Mínimo Viável), mas apresenta limitações significativas para suportar as funcionalidades avançadas observadas no Clint CRM, como automações dinâmicas, playbooks de vendas e inteligência de dados (BI) granular.

A principal limitação reside na **rigidez** do modelo `Lead`, que utiliza `enums` para os status de pipeline (`statusHT`, `statusLT`). Isso impede a customização do funil pelo administrador, uma característica essencial para a escalabilidade de uma agência de marketing. Além disso, a ausência de modelos dedicados para auditoria e rastreamento de marketing compromete a capacidade de análise e conformidade.

A otimização proposta visa introduzir modelos de dados que garantam **flexibilidade**, **rastreabilidade** e **suporte a workflows complexos**.

## 2. Otimizações Propostas no Schema Prisma

O novo schema (`nobre_hub_optimized_schema.prisma`) introduz cinco novos modelos de dados e aprimora os modelos existentes.

### 2.1. Novos Modelos de Dados

| Modelo | Propósito | Funcionalidade Habilitada | Detalhes Técnicos |
| :--- | :--- | :--- | :--- |
| **`PipelineStage`** | Define as etapas do funil de forma dinâmica. | Customização de Funil (Kanban) e Playbooks | Substitui os `enums` de status. Permite que o Admin crie, edite e ordene as etapas. |
| **`Activity`** | Registra tarefas, chamadas, e-mails ou eventos. | Playbooks de Vendas e Gestão de Tarefas | Permite vincular atividades a um `Lead` e a uma `PipelineStage`, criando o conceito de Playbook. |
| **`LeadSourceData`** | Armazena dados de rastreamento de marketing. | BI e Rastreamento de ROI | Modelo 1:1 com `Lead`. Armazena `utm_source`, `utm_medium`, `utm_campaign`, etc., essencial para o módulo de Relatórios. |
| **`AuditLog`** | Registra todas as alterações críticas no sistema. | Histórico de Auditoria e Conformidade | Armazena quem (`userId`), o que (`targetModel`, `targetId`) e a ação (`AuditAction`) realizada, com `oldValue` e `newValue` em formato JSON. |
| **`AutomationFlow`** | Armazena a definição de um fluxo de automação. | Flow Builder Visual | Contém o `flowDefinition` em formato JSON (grafo) para ser interpretado pelo backend, permitindo automações complexas. |

### 2.2. Impacto nos Modelos Existentes

| Modelo | Alteração | Justificativa |
| :--- | :--- | :--- |
| **`Lead`** | Remoção de `statusHT` e `statusLT`. Adição de `pipelineStageId` (relação com `PipelineStage`). | Transforma o funil de estático (enums) para dinâmico (tabela), suportando customização. |
| **`Lead`** | Adição de `lastActivityAt`. | Permite consultas rápidas para identificar leads "frios" (sem atividade recente), crucial para a gestão de vendas. |
| **`Message`** | Adição de `mediaUrl`. | Suporte a mensagens de áudio e imagem (WhatsApp), armazenando o arquivo no Object Storage (S3/Supabase Storage) e o link aqui. |
| **`User`** | Adição de relações (`activities`, `auditLogs`). | Facilita a consulta de todas as ações e tarefas atribuídas a um agente. |

## 3. Habilitando Funcionalidades Complexas

A nova arquitetura de dados é o alicerce para as funcionalidades de alta complexidade:

### 3.1. Playbooks de Vendas e Tarefas
A combinação dos modelos **`PipelineStage`** e **`Activity`** permite a criação de Playbooks. Por exemplo, ao mover um `Lead` para a etapa "Proposta" (`PipelineStage`), o backend pode automaticamente criar uma `Activity` do tipo "call" com o `dueDate` para 24 horas, garantindo que o vendedor siga o processo ideal.

### 3.2. Inteligência de Dados (BI)
O modelo **`LeadSourceData`** desacopla os dados de rastreamento do registro principal do `Lead`. Isso permite que o backend colete dados de UTMs e referrers na criação do lead e os armazene de forma estruturada. O módulo de Relatórios (Analytics.tsx) poderá então fazer consultas SQL eficientes para calcular o **ROI por Campanha** e o **Funil de Conversão** por origem.

### 3.3. Automação e Workflows
O modelo **`AutomationFlow`** armazena a lógica do Flow Builder. Quando um gatilho ocorre (ex: `Lead` muda de etapa), o backend consulta o `flowDefinition` (JSON) e executa as ações definidas (ex: enviar mensagem, criar tarefa, atribuir agente), tornando o sistema altamente configurável sem a necessidade de alterações no código.

## 4. Considerações de Migração

A transição do schema atual para o otimizado exigirá uma migração de dados.

1.  **Criação dos `PipelineStage`:** Antes de migrar os leads, o administrador deve criar as novas etapas na tabela `PipelineStage` (ex: "Novo", "Qualificado", "Fechado").
2.  **Migração de `Lead`:**
    *   O campo `phone` deve ser verificado para garantir a unicidade antes de aplicar a restrição `@unique`.
    *   Os leads existentes devem ser mapeados dos antigos `enums` (`statusHT`, `statusLT`) para o novo `pipelineStageId` correspondente.
3.  **Prisma Migrate:** Utilize o `Prisma Migrate` para gerenciar a transição do banco de dados, garantindo que as novas tabelas e colunas sejam criadas de forma segura.

A implementação desta arquitetura garantirá que o Nobre Hub não apenas replique as funcionalidades da Clint, mas também tenha uma base de dados robusta e flexível para o crescimento futuro.
