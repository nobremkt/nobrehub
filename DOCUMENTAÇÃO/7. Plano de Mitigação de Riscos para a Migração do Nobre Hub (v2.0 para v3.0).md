# Plano de Mitigação de Riscos para a Migração do Nobre Hub (v2.0 para v3.0)

A migração de um sistema em produção envolve riscos inerentes à integridade dos dados e à continuidade do serviço. Este plano detalha as estratégias de mitigação para os dois pontos mais críticos identificados na transição para o Schema Prisma Otimizado (v3.0).

## 1. Risco Crítico 1: Unificação de Leads (Restrição `@unique` em `Lead.phone`)

### 1.1. Risco Associado
A introdução da restrição `@unique` no campo `Lead.phone` é essencial para a integridade do CRM, mas pode falhar se houver registros duplicados no banco de dados atual. A falha resultará na interrupção da migração e na potencial corrupção do banco de dados.

### 1.2. Plano de Mitigação de Riscos

A mitigação deve ser executada em um ambiente de **pré-migração** e envolve a identificação e resolução proativa dos conflitos.

| Etapa | Ação Detalhada | Objetivo de Mitigação |
| :--- | :--- | :--- |
| **1. Identificação** | Executar uma *query* de agrupamento para listar todos os números de telefone que aparecem mais de uma vez na tabela `Lead`. | Quantificar o problema e identificar os registros a serem tratados. |
| **2. Definição de Política** | Definir uma política de unificação com a equipe de vendas. **Sugestão:** Manter o Lead com a `Conversation` mais recente ou o `Lead` com o maior `estimatedValue`. | Evitar a perda de dados críticos ao definir qual registro "sobrevive". |
| **3. Script de Unificação** | Desenvolver um script transacional que: 1. Identifica o Lead "mestre" (o que será mantido). 2. Reassocia todos os registros relacionados (`Message`, `Conversation`, etc.) dos Leads duplicados para o Lead mestre. 3. Deleta os Leads duplicados. | Garantir que o histórico do cliente seja preservado e vinculado ao registro único. |
| **4. Validação** | Re-executar a *query* de identificação para confirmar que o número de duplicatas é zero. | Assegurar que a restrição `@unique` será aplicada com sucesso. |
| **5. Implementação** | Aplicar a restrição `@unique` no `schema.prisma` e executar o `prisma migrate`. | Finalizar a mitigação, garantindo a integridade futura dos dados. |

---

## 2. Risco Crítico 2: Conversão de Status (Enum para `PipelineStage` ID)

### 2.1. Risco Associado
A conversão dos valores estáticos dos `enums` (`statusHT`, `statusLT`) para o novo `pipelineStageId` (chave estrangeira) é um processo de mapeamento. Um mapeamento incorreto resultará em leads posicionados na etapa errada do funil, comprometendo a operação de vendas e os relatórios de funil.

### 2.2. Plano de Mitigação de Riscos

A mitigação deve focar na precisão do mapeamento e na capacidade de reversão.

| Etapa | Ação Detalhada | Objetivo de Mitigação |
| :--- | :--- | :--- |
| **1. Mapeamento Definitivo** | Criar uma tabela de mapeamento (ex: arquivo JSON ou CSV) validada pela equipe de gestão, relacionando cada valor antigo (`statusHT` ou `statusLT`) ao novo `PipelineStage.id`. | Eliminar erros de interpretação no script de migração. |
| **2. Criação de `PipelineStage`** | **Antes da migração de dados**, o script deve popular a nova tabela `PipelineStage` com as etapas definidas. | Garantir que os IDs de destino (`pipelineStageId`) existam antes de tentar atribuí-los aos Leads. |
| **3. Migração em Duas Fases (Soft Migration)** | **Fase A:** Adicionar uma coluna temporária (`oldStatus`) na tabela `Lead` para *backup* dos valores antigos. **Fase B:** Adicionar a coluna `pipelineStageId` (que pode ser nula inicialmente). | Permitir a reversão imediata do mapeamento se o resultado for insatisfatório. |
| **4. Script de Mapeamento Transacional** | Executar o script de mapeamento que lê o `oldStatus` e, usando a tabela de mapeamento, atualiza o `pipelineStageId`. O script deve ser executado dentro de uma transação. | Garantir que a operação seja atômica (ou tudo é feito, ou nada é feito). |
| **5. Validação Pós-Migração** | **Spot Check:** Selecionar aleatoriamente 20 leads de cada pipeline e verificar se o `pipelineStageId` corresponde ao `oldStatus` de backup. **Validação Operacional:** A equipe de vendas deve validar o Kanban no ambiente de *staging*. | Confirmar a precisão do mapeamento antes de liberar para produção. |
| **6. Limpeza** | Após a validação em produção, remover a coluna temporária `oldStatus`. | Finalizar a mitigação e limpar o schema. |

## 3. Plano de Contingência Geral (Rollback)

Apesar das mitigações específicas, um plano de contingência geral é obrigatório.

| Risco | Plano de Contingência |
| :--- | :--- |
| **Falha na Migração (Qualquer Etapa)** | **Backup Imediato:** Realizar um *dump* completo do banco de dados antes de iniciar a migração. Em caso de falha, restaurar o banco de dados a partir deste *dump*. |
| **Erro de Lógica Pós-Migração** | **Feature Flag:** Implementar *feature flags* para as novas funcionalidades (ex: Playbooks, novo Kanban). Se houver um erro crítico, desabilitar a *feature flag* e reverter para a lógica de código antiga, mantendo o banco de dados no v3.0 (se a migração de dados tiver sido validada). |
| **Downtime Inesperado** | **Janela de Manutenção:** Agendar a migração para um horário de baixo tráfego (ex: madrugada ou fim de semana) e comunicar a janela de manutenção à equipe. |
