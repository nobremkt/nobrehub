# Estratégia de Migração de Dados para o Schema Prisma Otimizado (v3.0)

A migração para o Schema Prisma Otimizado (v3.0) é um passo crucial para a escalabilidade do Nobre Hub. Esta estratégia foca em minimizar o *downtime*, garantir a integridade dos dados e estabelecer a ordem correta para a implementação dos novos modelos.

## 1. Pontos Críticos da Migração

A migração de um schema baseado em `enums` para um baseado em chaves estrangeiras (`PipelineStage`) é o ponto de maior atenção.

| Ponto Crítico | Descrição | Solução Proposta |
| :--- | :--- | :--- |
| **Unicidade do Telefone** | O novo `Lead.phone` deve ter a restrição `@unique`. Se houver duplicatas no banco atual, a migração falhará. | **Pré-Migração:** Executar um script de limpeza para identificar e unificar/remover leads duplicados por telefone. |
| **Migração de Status** | Os campos `statusHT` e `statusLT` (enums) devem ser convertidos para `pipelineStageId` (chave estrangeira). | **Passo 3:** Criar a tabela `PipelineStage` e, em seguida, executar um script de mapeamento de dados. |
| **`mediaUrl` em `Message`** | O novo campo `mediaUrl` deve ser populado para mensagens de mídia existentes (se houver). | **Pós-Migração:** Implementar o Supabase Storage e um script para migrar mídias antigas, atualizando o campo. |
| **`LeadSourceData`** | O novo modelo 1:1 com `Lead` deve ser populado com dados de origem existentes. | **Pós-Migração:** Se houver dados de origem em outros campos do `Lead`, criar um script para extrair e popular a nova tabela. |

## 2. Ordem de Implementação e Migração

A migração deve ser realizada em fases lógicas, garantindo que as dependências sejam resolvidas antes da alteração dos modelos principais.

### Fase 1: Preparação e Criação de Novos Modelos (Sem Relação Crítica)

Nesta fase, criamos os modelos que não dependem diretamente de alterações nos modelos `Lead` ou `Conversation`.

| Ação | Modelo(s) Envolvido(s) | Justificativa |
| :--- | :--- | :--- |
| **1. Executar `prisma migrate dev`** | `AuditLog`, `AutomationFlow`, `LeadSourceData` | Cria as novas tabelas. Não há dados antigos para migrar, apenas novos modelos para futuras funcionalidades. |
| **2. Ajustar `User` e `Conversation`** | `User`, `Conversation` | Adicionar as novas relações (ex: `User.auditLogs`, `Conversation.assignedAgent`). Não afeta dados existentes. |
| **3. Ajustar `Message`** | `Message` | Adicionar o campo `mediaUrl`. O campo pode ser nulo inicialmente. |

### Fase 2: Migração Crítica do `Lead` (Conversão de Status)

Esta é a fase mais sensível, onde a estrutura do funil é alterada.

| Ação | Modelo(s) Envolvido(s) | Justificativa |
| :--- | :--- | :--- |
| **4. População de `PipelineStage`** | `PipelineStage` | **Manual/Script:** O administrador deve definir as etapas (ex: "Qualificação", "Proposta") e seus IDs. |
| **5. Script de Pré-Migração** | `Lead` | **Script:** Garantir que `Lead.phone` seja único, limpando ou unificando duplicatas. |
| **6. Alteração do `Lead`** | `Lead` | **Prisma Migrate:** Remover `statusHT` e `statusLT`. Adicionar `pipelineStageId`. |
| **7. Script de Mapeamento** | `Lead` | **Script:** Mapear os valores antigos de `statusHT`/`statusLT` para o novo `pipelineStageId` (ex: `statusHT = 'qualificado'` → `pipelineStageId = 'uuid_qualificacao'`). |

### Fase 3: Implementação de Playbooks e Atividades

Nesta fase, o conceito de Playbook é introduzido.

| Ação | Modelo(s) Envolvido(s) | Justificativa |
| :--- | :--- | :--- |
| **8. Criação de `Activity`** | `Activity` | Criar a tabela `Activity` e suas relações com `Lead` e `PipelineStage`. |
| **9. Backfill de Atividades** | `Activity` | **Script:** Se houver um histórico de notas ou tarefas em outro lugar, migrá-las para o novo modelo `Activity`. |
| **10. Criação de Playbooks** | `AutomationFlow` | **Manual:** O administrador/desenvolvedor cria os primeiros Playbooks de Vendas no formato JSON. |

## 3. Plano de Rollback

Em caso de falha na migração (especialmente na Fase 2), o plano de rollback deve ser:

1.  **Reverter o Código:** Reverter o código-fonte do backend e frontend para a versão anterior à migração.
2.  **Reverter o Banco de Dados:** Utilizar o comando `prisma migrate resolve --rolled-back "nome_da_migracao"` para reverter a última migração e restaurar o schema v2.0.
3.  **Análise:** Investigar a causa da falha (provavelmente erro no script de mapeamento ou duplicidade de dados) e corrigir antes de tentar novamente.

A execução desta estratégia em um ambiente de *staging* ou *sandbox* é **obrigatória** antes de aplicar em produção.
