# Estrutura de Dados para Playbooks de Vendas com Lógica Condicional

A funcionalidade de **Playbooks de Vendas** no Nobre Hub será implementada como uma aplicação específica do modelo **`AutomationFlow`** introduzido no Schema Prisma Otimizado (v3.0). Um Playbook é, essencialmente, um fluxo de trabalho automatizado que guia o vendedor ou executa ações de forma autônoma.

## 1. Modelos de Dados Envolvidos

O Playbook utiliza a sinergia de três modelos principais:

| Modelo | Função no Playbook |
| :--- | :--- |
| **`AutomationFlow`** | Armazena a definição completa do Playbook (gatilho, condições e ações). |
| **`PipelineStage`** | Define o **Gatilho** do Playbook (ex: quando um lead entra nesta etapa). |
| **`Activity`** | Define as **Ações** de tarefa/follow-up a serem criadas para o vendedor. |

## 2. Estrutura do `AutomationFlow.flowDefinition` (JSON)

O campo `flowDefinition` do modelo `AutomationFlow` deve ser um objeto JSON que define o grafo do fluxo de trabalho. Ele deve ser flexível o suficiente para suportar gatilhos, ações e lógica condicional (IF/ELSE).

### 2.1. Estrutura Base

```json
{
  "trigger": {
    "type": "LEAD_STAGE_CHANGE",
    "stageId": "uuid_do_stage_alvo" // Ex: Gatilho ao entrar na etapa "Qualificação"
  },
  "steps": [
    // Array de objetos que definem a sequência e a lógica do fluxo
  ]
}
```

### 2.2. Tipos de Steps (Passos)

Cada objeto dentro do array `steps` pode ser de três tipos principais:

#### A. Step de Ação (`ACTION`)

Executa uma tarefa específica.

| Campo | Tipo | Descrição | Exemplo de `actionType` |
| :--- | :--- | :--- | :--- |
| `id` | String | ID único do passo no fluxo. | `step_2_A` |
| `type` | String | Deve ser `"ACTION"`. | |
| `actionType` | String | O tipo de ação a ser executada. | `CREATE_ACTIVITY`, `SEND_WHATSAPP_TEMPLATE`, `UPDATE_LEAD` |
| `payload` | Objeto | Dados necessários para a ação. | `{ "description": "Ligar para Lead", "dueDate": "NOW + 1 DAY" }` |
| `next` | Array<String> | IDs dos próximos passos a serem executados. | `["step_3"]` |

#### B. Step Condicional (`CONDITION`)

Introduz lógica IF/ELSE no fluxo, permitindo ramificações.

| Campo | Tipo | Descrição |
| :--- | :--- | :--- |
| `id` | String | ID único do passo. |
| `type` | String | Deve ser `"CONDITION"`. |
| `condition` | Objeto | Define a regra de comparação (campo, operador, valor). |
| `onTrue` | Array<String> | IDs dos passos a seguir se a condição for verdadeira. |
| `onFalse` | Array<String> | IDs dos passos a seguir se a condição for falsa. |

**Exemplo de Objeto `condition`:**
```json
{
  "field": "Lead.estimatedValue",
  "operator": "GREATER_THAN",
  "value": 10000
}
```

#### C. Step de Espera (`WAIT`)

Pausa a execução do fluxo por um período ou até um evento.

| Campo | Tipo | Descrição |
| :--- | :--- | :--- |
| `id` | String | ID único do passo. |
| `type` | String | Deve ser `"WAIT"`. |
| `waitType` | String | Tipo de espera. | `DURATION` (tempo), `UNTIL_EVENT` (ex: lead respondeu) |
| `payload` | Objeto | Detalhes da espera. | `{ "duration": "24 HOURS" }` |
| `next` | Array<String> | IDs dos próximos passos. |

## 3. Exemplo de Playbook Condicional

**Cenário:** Quando um Lead entra na etapa "Qualificação", se o valor estimado for maior que R$10.000, cria uma tarefa de ligação urgente. Caso contrário, envia um template de WhatsApp de qualificação automática.

```json
{
  "trigger": {
    "type": "LEAD_STAGE_CHANGE",
    "stageId": "uuid_qualificacao"
  },
  "steps": [
    {
      "id": "step_1_check_value",
      "type": "CONDITION",
      "condition": {
        "field": "Lead.estimatedValue",
        "operator": "GREATER_THAN",
        "value": 10000
      },
      "onTrue": ["step_2_A_task"],
      "onFalse": ["step_2_B_whatsapp"]
    },
    {
      "id": "step_2_A_task",
      "type": "ACTION",
      "actionType": "CREATE_ACTIVITY",
      "payload": {
        "description": "Ligar (Prioridade) - Lead de Alto Valor",
        "dueDate": "NOW + 1 HOUR",
        "activityType": "call"
      }
    },
    {
      "id": "step_2_B_whatsapp",
      "type": "ACTION",
      "actionType": "SEND_WHATSAPP_TEMPLATE",
      "payload": {
        "templateName": "Qualificacao_Automatica",
        "variables": ["Lead.name"]
      }
    }
  ]
}
```

Esta estrutura, combinada com um motor de execução de workflows no backend (que pode ser implementado com bibliotecas como `BullMQ` para tarefas assíncronas), oferece a flexibilidade e o poder de automação necessários para o Nobre Hub.
