// -----------------------------------------------------------------
// NOBRE HUB - SCHEMA PRISMA OTIMIZADO (v3.0)
// Foco: Escalabilidade, Automação, BI e Auditoria
// -----------------------------------------------------------------

// -----------------------------------------------------------------
// ENUMS EXPANDIDOS
// -----------------------------------------------------------------

enum UserRole { admin, sdr, closer_ht, closer_lt, production, post_sales, manager_sales, manager_production, strategic }
enum PipelineType { high_ticket, low_ticket, sales, production, post_sales }
enum MessageDirection { in, out }
enum MessageStatus { pending, sent, delivered, read, failed }
enum ConversationStatus { queued, active, closed }
enum ActivityType { task, call, email, meeting, custom }
enum AuditAction { create, update, delete, stage_change, assignment }

// -----------------------------------------------------------------
// MODELOS EXISTENTES (COM MELHORIAS)
// -----------------------------------------------------------------

model User {
  id                   String       @id @default(uuid())
  email                String       @unique
  passwordHash         String
  name                 String
  role                 UserRole
  pipelineType         PipelineType?
  isActive             Boolean      @default(true)
  maxConcurrentChats   Int          @default(5)
  currentChatCount     Int          @default(0)
  isOnline             Boolean      @default(false)
  
  // Relações
  assignedLeads        Lead[]       @relation("AssignedLeads")
  activities           Activity[]   @relation("UserActivities")
  auditLogs            AuditLog[]   @relation("UserAuditLogs")
  conversations        Conversation[] @relation("AssignedConversations")
}

model Lead {
  id                   String       @id @default(uuid())
  name                 String
  email                String?
  phone                String       @unique // Assumindo que o telefone é o identificador único
  company              String?
  
  // Status e Pipeline
  pipeline             PipelineType
  pipelineStageId      String       // Chave estrangeira para PipelineStage
  
  assignedToId         String?
  assignedTo           User?        @relation("AssignedLeads", fields: [assignedToId], references: [id])
  
  estimatedValue       Decimal      @default(0)
  tags                 String[]
  notes                String?
  contactReason        String?
  
  // Relações
  sourceData           LeadSourceData? // 1:1 para dados de rastreamento
  activities           Activity[]
  conversations        Conversation[]
  auditLogs            AuditLog[]
  
  // Timestamps
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  lastActivityAt       DateTime?
}

model Conversation {
  id                   String              @id @default(uuid())
  leadId               String
  lead                 Lead                @relation(fields: [leadId], references: [id])
  
  assignedAgentId      String?
  assignedAgent        User?               @relation("AssignedConversations", fields: [assignedAgentId], references: [id])
  
  channel              String              // whatsapp, instagram, email
  status               ConversationStatus
  closedReason         String?
  pipeline             PipelineType
  
  // Relações
  messages             Message[]
  
  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  lastMessageAt        DateTime?
}

model Message {
  id                   String           @id @default(uuid())
  waMessageId          String?          @unique
  conversationId       String
  conversation         Conversation     @relation(fields: [conversationId], references: [id])
  
  direction            MessageDirection
  type                 String           // text, image, audio, template
  text                 String?
  mediaUrl             String?          // NOVO: URL para áudios, imagens, etc. (S3/Supabase Storage)
  
  status               MessageStatus
  sentByUserId         String?          // Agente que enviou
  
  // Timestamps
  createdAt            DateTime         @default(now())
}

// -----------------------------------------------------------------
// NOVOS MODELOS PARA FUNCIONALIDADES AVANÇADAS
// -----------------------------------------------------------------

// 1. Rastreamento de Marketing (BI)
model LeadSourceData {
  id                   String       @id @default(uuid())
  leadId               String       @unique
  lead                 Lead         @relation(fields: [leadId], references: [id])
  
  source               String       // website, instagram, whatsapp, etc.
  utmSource            String?
  utmMedium            String?
  utmCampaign          String?
  utmContent           String?
  utmTerm              String?
  
  initialReferrer      String?      // URL de onde veio
  
  createdAt            DateTime     @default(now())
}

// 2. Playbooks e Atividades (Playbook de Vendas)
model PipelineStage {
  id                   String       @id @default(uuid())
  pipelineType         PipelineType
  name                 String       // Ex: Qualificação, Proposta
  order                Int          @default(0)
  
  // Relações
  activities           Activity[]   @relation("StageActivities")
}

model Activity {
  id                   String       @id @default(uuid())
  leadId               String
  lead                 Lead         @relation(fields: [leadId], references: [id])
  
  type                 ActivityType
  description          String
  dueDate              DateTime?
  isCompleted          Boolean      @default(false)
  
  assignedToId         String?
  assignedTo           User?        @relation("UserActivities", fields: [assignedToId], references: [id])
  
  // Relação com Playbook (se for parte de um)
  pipelineStageId      String?
  pipelineStage        PipelineStage? @relation("StageActivities", fields: [pipelineStageId], references: [id])
  
  // Timestamps
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
}

// 3. Auditoria (Audit Log)
model AuditLog {
  id                   String       @id @default(uuid())
  
  // Quem fez
  userId               String?
  user                 User?        @relation("UserAuditLogs", fields: [userId], references: [id])
  
  // O que foi afetado
  targetModel          String       // Ex: Lead, Conversation, User
  targetId             String       // ID do registro afetado
  
  action               AuditAction
  
  // Detalhes da mudança (JSON)
  oldValue             Json?
  newValue             Json?
  
  // Timestamps
  createdAt            DateTime     @default(now())
}

// 4. Automação (Flow Builder)
model AutomationFlow {
  id                   String       @id @default(uuid())
  name                 String
  isActive             Boolean      @default(false)
  
  // Estrutura do fluxo (JSON)
  flowDefinition       Json         // O grafo do Flow Builder (gatilhos, ações, condições)
  
  // Timestamps
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
}

// -----------------------------------------------------------------
// FIM DO SCHEMA OTIMIZADO
// -----------------------------------------------------------------
